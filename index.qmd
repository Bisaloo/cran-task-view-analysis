---
title: "`r yaml::read_yaml('settings.yml')$view` Task View analysis"
author: "James Baker, Chathura Edirisuriya, Hugo Gruson"
logo: images/logo_white.svg
date: last-modified
format: 
  dashboard:
    orientation: columns
    nav-buttons: github
theme: 
  - cosmo
  - custom.scss
---

```{r}
knitr::opts_chunk$set(
  echo = FALSE
)
```

```{r}
tf <- tempfile(fileext = ".md")
download.file(
  paste0(
    "https://github.com/cran-task-views/",
    yaml::read_yaml("settings.yml")$view,
    "/raw/main/",
    yaml::read_yaml("settings.yml")$view,
    ".md"
  ),
  tf
)
```

```{r, message = FALSE}
library(ctv)
library(pkgsearch)
library(dplyr)
library(purrr)
library(ggplot2)
theme_set(theme_minimal())
```

```{r}
ctv_pkgs <- ctv::read.ctv(tf) %>%
  purrr::pluck("packagelist", "name") 
```

```{r, cache = TRUE}
pkg_versions <- ctv_pkgs |> 
  purrr::map(pkgsearch::cran_package_history) |> 
  dplyr::bind_rows() |> 
  dplyr::mutate(
    date = lubridate::ymd_hms(date),
    maintainer = trimws(stringr::str_extract(Maintainer, "^[^<]+"))
  )
```

```{r}
ctv_pkg_descriptions <- pkg_versions |> 
  group_by(Package) |> 
  filter(date == max(date)) |> 
  ungroup()
```

```{r}
authors <- pkg_versions |> 
  dplyr::transmute(
    Author = gsub("<U+000a>", " ", Author, fixed = TRUE),
    Author = gsub(" and ", ", ", Author, fixed = TRUE),
    Author = gsub("\\bwith contributions (of|from|by)\\b", ", ", Author),
    parsed_authors_r = purrr::map(`Authors@R`, ~ tryCatch(format(eval(parse(text = .x)), include = c("given", "family")), error = function(e) NA)),
    parsed_authors = strsplit(gsub("<[^>]*>", "", gsub("\\([^)]*\\)", "", gsub("\\[(\\w| |,)*\\]", "", Author))), "[[:space:]]*,+[[:space:]]*,*"),
    date = date
  ) |> 
  dplyr::transmute(
    auts = coalesce(parsed_authors, parsed_authors_r),
    auts = map(auts, stringi::stri_trans_general, "ASCII"),
    auts = map(auts, stringr::str_remove_all, "[[:punct:]]"),
    auts = map(auts, trimws),
    date = date
  ) |> 
  tidyr::unnest_longer(auts)
```

## Best practices {width=33%}

### Row {height=20%}

#### Col

```{r}
#| content: valuebox
#| title: "Number of packages"
list(
  color = "#10BED2",
  value = nrow(ctv_pkg_descriptions)
)
```

#### Col

```{r}
#| content: valuebox
#| title: "Package authors"
list(
  color = "#AEC800",
  value = n_distinct(authors$auts)
)
```

### Row

```{r}
desc_checks <- ctv_pkg_descriptions %>%
  transmute(
    package            = Package,
    has_github_url     = startsWith(URL, "https://github.com/") | startsWith(BugReports, "https://github.com/"),
    uses_roxygen       = !is.na(RoxygenNote),
    has_knitr_vignette = grepl("knitr", VignetteBuilder),
    uses_testing       = purrr::map_lgl(dependencies, ~ any(.x$package %in% c("testthat", "testit", "unitizer", "RUnit", "tinytest"))),
    has_no_deprecated  = !purrr::map_lgl(dependencies, ~ any(.x$package %in% c("RUnit", "XML", "RCurl", "plyr", "reshape2"))),
    uses_authors_r     = !is.na(`Authors@R`),
    uses_orcid         = grepl("<https://orcid.org/", Author, fixed = TRUE)
  )
```

```{r load-gh-helpers}
library(httr)
source("_scripts/gh.R")
```

```{r, cache = TRUE}
gh_checks <- read.csv("https://raw.githubusercontent.com/cran-task-views/Epidemiology/main/data/source_repositories.csv") %>%
  transmute(
    package        = package,
    has_rmd_readme = purrr::map_lgl(github_repo, ~ gh_file_exists("README.Rmd", .x)),
    has_md_license = purrr::map_lgl(github_repo, ~ gh_file_exists("LICENSE.md", .x)),
    uses_pkgdown    = purrr::map_lgl(github_repo, ~ any(gh_file_list_exists(c("_pkgdown.yml", "_pkgdown.yaml", "pkgdown/pkgdown.yml"), .x))),
    uses_gha        = purrr::map_lgl(github_repo, ~ gh_file_exists(".github/workflows", .x)),
    has_news       = purrr::map_lgl(github_repo, ~ gh_file_exists("NEWS.md", .x))
  )
```

```{r}
all_checks <- merge(
  gh_checks,
  desc_checks,
  all = TRUE,
  by = "package"
)
n_pkgs <- nrow(all_checks)
```

```{r}
check_descriptions <- tribble(
  ~check, ~description,
  "has_github_url", "Has a GitHub URL",
  "uses_roxygen", "Uses Roxygen",
  "has_knitr_vignette", "Has a knitr vignette",
  "uses_testing", "Uses testing package",
  "has_no_deprecated", "Does not depend on deprecated packages (XML, RCurl, RUnit, plyr, reshape2)",
  "uses_authors_r", "Has Authors@R field",
  "uses_orcid", "Has ORCID in Author field",
  "has_rmd_readme", "Has README.Rmd",
  "has_md_license", "Has LICENSE.md",
  "uses_pkgdown", "Uses pkgdown",
  "uses_gha", "Uses GitHub Actions",
  "has_news", "Has NEWS.md"
)
```

```{r}
all_checks |>
  tibble::column_to_rownames("package") |>
  t() |>
  as.data.frame() |>
  tibble::rownames_to_column("check") |>
  left_join(check_descriptions) |>
  select(-check) |> 
  mutate(
    passed = rowSums(pick(-description), na.rm = TRUE) / n_pkgs * 100,
    .keep = "unused"
  ) |>
  arrange(desc(passed)) |> 
  gt::gt() |> 
  gt::fmt_number(
    columns = passed,
    decimals = 0,
    pattern = "{x}%"
  ) |> 
  gt::data_color(
    method = "numeric",
    palette = "viridis",
    domain = c(0, 100)
  )
```

## Authorship trends and sustainability {width=33%}

```{r}
maintainers_by_year <- pkg_versions |> 
  group_by(name = maintainer) |> 
  summarise(
    maintainer_since = lubridate::year(min(date))
  )

authors_by_year <- authors |>
  group_by(name = auts) |> 
  summarise(
    author_since = lubridate::year(min(date))
  )

full_join(maintainers_by_year, authors_by_year, by = "name") |>
  tidyr::pivot_longer(
    cols = c(maintainer_since, author_since),
    names_to = "role",
    values_to = "year"
  ) |> 
  dplyr::mutate(
    role = tools::toTitleCase(gsub("_since$", "", role))
  ) |> 
  ggplot(aes(x = year, fill = role)) +
    geom_histogram(binwidth = 1) +
    labs(
      title = "Recruitement of new authors & maintainers in the ecosystem",
      x = "Year",
      y = "Number of new authors/maintainers",
      fill = ""
    ) +
    theme(legend.position = "bottom") +
    scale_fill_brewer(palette = "Set2")
```

```{r}
source("_scripts/parse_archive.R")

yearly_archivals <- archive_df |> 
  filter(package %in% ctv_pkgs) |> 
  dplyr::mutate(
    date = lubridate::ymd(archivals),
    year = lubridate::year(date),
    .keep = "unused"
  ) |> 
  count(year, name = "archivals") |> 
  dplyr::mutate(archivals = -archivals)
```

```{r}
pkg_versions |> 
  dplyr::mutate(
    first_release = Version == min(Version), 
    maintainer_change = maintainer != dplyr::lag(maintainer),
    .by = Package
  ) |>
  dplyr::group_by(year = lubridate::year(date)) |> 
  summarise(
    updates = sum(!first_release),
    `first releases` = sum(first_release),
    `maintainer transitions` = sum(maintainer_change),
    .groups = "drop"
  ) |> 
  dplyr::full_join(yearly_archivals, by = "year") |> 
  tidyr::pivot_longer(
    cols = c(updates, `first releases`, `maintainer transitions`, archivals),
    names_to = "release_type",
    values_to = "yearly_releases"
  ) |>
  ggplot(aes(x = factor(year), y = yearly_releases, fill = release_type)) +
    geom_col() +
    labs(
      title = "New releases or package updates",
      x = "Year", y = "Number of releases",
      fill = ""
    ) +
    theme(legend.position = "bottom") +
    scale_fill_brewer(palette = "Set1")
```

## Dependencies and popularity {width=33%}

```{r}
pkg_versions |> 
  mutate(
    count_soft = map_int(dependencies, ~ sum(.x$type == "Suggests")),
    count_hard = map_int(dependencies, ~ n_distinct(.x$package[.x$type %in% c("Depends", "Imports", "LinkingTo")]))
  ) |> 
  tidyr::pivot_longer(
    cols = c(count_soft, count_hard),
    names_to = "type",
    values_to = "count"
  ) |>
  ggplot(aes(x = date, y = count, color = type)) +
    geom_point(alpha = 0.25) +
    geom_smooth() +
    labs(
      title = "Number of hard and soft dependencies over time",
      x = "Date",
      y = "Number of dependencies"
    ) +
    theme(legend.position = "bottom") +
    scale_color_brewer(palette = "Set2")
```
